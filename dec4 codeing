class Diagnosis:   # Initializes a Diagnosis class
  def __init__(self, name, symptoms, tests, differentialDiagnoses, treatment, prognosis):
    self.name = name
    self.symptoms = symptoms         # construct
    self.symptomsList = [i.lower().strip() for i in symptoms.split(',')]
    self.tests = tests
    self.differentialDiagnoses = differentialDiagnoses
    self.treatment = treatment
    self.prognosis = prognosis

  def calculateSimilarity(self,userSymptom,diagSymptom):
    userWords = set(userSymptom.lower().split())         # create a set of user input sympts and diagnosis sympts                
    diagWords = set(diagSymptom.lower().replace('/',' ').split()) 
    wordsInCommon = userWords.intersection(diagWords)           
    if not userWords or not diagWords:              #figure out if they have any words in common, adn provide an overlap score
      return 0.0                                #based on the total words in common / total words in both user and diagnosis sympts
    overlapScore = len(wordsInCommon)/len(userWords.union(diagWords))  
    if userSymptom.lower() in diagSymptom.lower():
      overlapScore += 0.3                             #gives a bonus if the user input directly matches the diagnosis' sympts
    elif diagSymptom.lower() in userSymptom.lower():  
      overlapScore += 0.2
    return min(overlapScore,1.0)

  def getMatchScore(self,userSymptoms,threshold=0.3):
    totalScore = 0.0
    matchedPairs = []   #set relevant vars
    matchedDetails = {}
    for userSymptom in userSymptoms:     
      bestMatchScore = 0.0    #vars assigned to each word the user inputs
      bestMatchSymptom = None
      for diagSymptom in self.symptomsList:  #iterates over symptoms keywords, then calls the calculate function        
        score = self.calculateSimilarity(userSymptom,diagSymptom)  # effectively comparing every diagnosis' symptm keywords to the users input sympts
        if score > bestMatchScore:    # if we find a new high score we make that our best match score&symptom
          bestMatchScore = score
          bestMatchSymptom = diagSymptom
      if bestMatchScore >= threshold:   #remember what each symptom best matches with
        totalScore+=bestMatchScore
        matchedPairs.append((userSymptom, bestMatchSymptom, bestMatchScore))
        matchedDetails[userSymptom] = {
            'matched to':bestMatchSymptom,
            'score':bestMatchScore
        }
    actualScore = totalScore / len(userSymptoms) if userSymptoms else 0.0   #calculate average score of the entire sentecne
    return actualScore, matchedPairs, matchedDetails


  def __str__(self):          # display
   return f"""
======================================================
Diagnosis: {self.name}
Symptoms: {self.symptoms}
Tests: {self.tests}
Differential Diagnoses: {self.differentialDiagnoses}
Treatment: {self.treatment}
Prognosis: {self.prognosis}
======================================================
"""

def container():                 # list of diagnoses,,
  diagnoses = [
    Diagnosis("Diabetes.",
              "Increased thirst, Frequent Urination, Fatigue, Blurred Vision.",
              "A1C test, blood sugar tests, oral glucose tolerance test.",
              "Hyperglycemia, endocrine disorders, pancreatic diseases.",
              "Insulin, diet alterations.",
              "Potential for strokes, nerve & kidney damage, Vision loss, and a requirment to track insulin."),
    Diagnosis("Coronavirus.",
              "Runny/Stuffy Nose, Sore Throat, Coughing/Sneezing.",
              "Nose Swab, Antigen tests, or PCR tests.",
              "Influenza, Common Cold, Respiatory Syncytial Virus.",
              "Rest and Quarantine.",
              "Asymptomatic infection."),
    Diagnosis("Influenza.",
              "Fever, Headaches/MuscleAches, Fatigue, Coughing/Sneezing, Stuffy nose.",
              "Molecular assays, Rapid influenza diagnostic.",
              "Common cold, Covid-19, Respiratory Syncytial Vorus (RSV), Human Parainfluenza Viruses (HPIV).",
              "Oseltamivir (Tamiflu), Baloxvir marboxil (Xofluza).",
              "High-risk group, Possible complications."),
    Diagnosis("Arthritis.",
              "Joint pain, Stiffness, Swelling, Redness",
              "Clinical evaluation, Laboratory tests, Imaging studies.",
              "Osteoarthritis, Rheumatoid athritis.",
              "Crystal-induced arthritis.",
              "Infectious arthritis."),
    Diagnosis("Hypertension",
              "Headaches, Nosebleeds, Ear Ringing.",
              "Blood pressure measurement, Ambulatory monitoring, Laboratory tests.",
              "White coat hypertension, Secondary hypertension, Essential hypertension.",
              "Lifestyle modifications, ACE inhibitors, Beta-blockers, Calcium channel blockers, Diuretics.",
              "Controllable with medication; potential complications include heart attack, stroke, kidney damage."),
    Diagnosis("Kidney Cancer",
              "Blood in Urine, Back Pain, Lump in the abdomen.",
              "CT scan, Biopsy, Urinalysis.",
              "Kidney cysts, Stones, Infections.",
              "Surgery, Immunotherapy, Targeted therapy.",
              "Good if caught early; varies by stage."),
    Diagnosis("Asthma",
              "Wheezing, Shortness of breath, Chest tightness, Coughing.",
              "Spirometry, Peak flow test, Chest X-ray.",
              "Bronchitis, COPD, Heart failure, Anxiety.",
              "Inhalers, Steroids, Avoid triggers.",
              "Chronic but manageable with treatment."),
    Diagnosis("Migraine.",
              "Head pain, Sensitivity to light, Nausea/vomiting.",
              "Neurological exam, MRI, CT scan.",
              "Tension headache, Sinus headache, Cluster headache.",
              "Pain relievers, Triptans, Preventive medications.",
              "Chronic condition with episodic attacks; manageable."),
    Diagnosis("Pneumonia",
              "Cough, Fever, Chills, Shortness of Breath, Chest Pain, Fatigue/Weakness, Nausea",
              "Chest X-ray, Blood tests, Sputum culture.",
              "Bronchitis, COPD exacerbation, COVID-19, Heart failure.",
              "Antibiotics (if bacterial), Rest, Fluids.",
              "Can become severe in elderly or immunocompromised patients."),
    Diagnosis("Appendicitis",
              "Abdominal pain, Loss of appetite, Nausea, Vomiting.",
              "CT scan, Ultrasound, Blood tests.",
              "Gastroenteritis, Ovarian torsion, Kidney stones.",
              "Surgical removal of appendix.",
              "Excellent prognosis with early surgery."),
    Diagnosis("Gallstones",
              "Sudden intense pain in Abdomen/Back/Shoulders.",
              "Ultrasound, CT scan, HIDA scan.",
              "Gallbladder inflammation, Kidney stones, Pancreatitis.",
              "Diet changes, Pain relief, Surgery (cholecystectomy).",
              "Good prognosis after removal; risk of recurrence if untreated."),
    Diagnosis("Anemia",
              "Fatigue, Weakness, Shortness of breath, Diziness, Headaches.",
              "CBC, Iron studies, B12/folate levels.",
              "Thalassemia, Chronic disease anemia, Acute blood loss.",
              "Iron supplements, B12 injections, Treat underlying cause.",
              "Often reversible if underlying cause is addressed."),
    Diagnosis("Hypothyroidism",
              "Fatigue, Weight gain, Constipation, Dry Skin, Thinning Hair.",
              "TSH and T4 blood tests.",
              "Depression, Anemia, Chronic fatigue, Menopause.",
              "Levothyroxine therapy.",
              "Requires lifelong medication but very manageable."),
    Diagnosis("Hyperthyroidism",
              "Increased heart rate, Weight Loss, Excessive Sweating, Anxiety.",
              "TSH, T3/T4 levels, Thyroid scan.",
              "Anxiety, Cardiac arrhythmias, Weight loss disorders.",
              "Antithyroid drugs, Radioiodine therapy, Surgery.",
              "Treatable; untreated can cause heart complications."),
    Diagnosis("Chronic Obstructive Pulmonary Disease",
              "Persistent Cough, Wheezing, Chest tightness, Shortness of Breath.",
              "Spirometry, Chest X-ray, CT scan.",
              "Asthma, Bronchiectasis, Heart failure.",
              "Bronchodilators, Steroids, Oxygen therapy.",
              "Chronic and progressive; symptom-focused treatment."),
    Diagnosis("Depression",
              "Persistent Sadness, Change in appetite.",
              "Clinical interview, Psychological evaluation.",
              "Bipolar disorder, Anxiety disorders, Hypothyroidism.",
              "Therapy, SSRIs, Lifestyle interventions.",
              "Highly treatable with consistent care."),
    Diagnosis("Generalized Anxiety Disorder",
              "Restlessness, Feeling on edge, Irritability, Sleep Disturbances.",
              "Clinical evaluation, Screening questionnaires.",
              "Hyperthyroidism, Panic disorder, PTSD.",
              "Therapy (CBT), SSRIs, Stress-reduction techniques.",
              "Chronic but manageable with treatment."),
    Diagnosis("Peptic Ulcer Disease",
              "Burning pain in upper abdomen.",
              "Endoscopy, H. pylori testing, Upper GI series.",
              "Gastritis, GERD, Gallbladder disease.",
              "Antibiotics (if H. pylori), PPIs, Avoid NSAIDs.",
              "Good prognosis with adequate treatment."),
    Diagnosis("Sinusitis",
              "Facial pain/pressure, Headaches, Nasal Congestion.",
              "Physical exam, CT scan (if chronic), Nasal endoscopy.",
              "Allergies, Migraine, Dental infections.",
              "Nasal steroids, Saline rinses, Antibiotics (if bacterial).",
              "Usually resolves; chronic cases need long-term management."),
    Diagnosis("Eczema (Atopic Dermatitis)",
              "Dry, itchy, scaly patches of skin.",
              "Clinical exam.",
              "Psoriasis, Contact dermatitis, Fungal infections.",
              "Topical steroids, Moisturizers, Avoid triggers.",
              "Chronic flares but controllable."),
    Diagnosis("Psoriasis",
              "Red, itchy, scaly patches of skin.",      
              "Skin exam, Biopsy if needed.",
              "Eczema, Fungal infections, Lupus.",
              "Topical treatments, Phototherapy, Biologics.",
              "Chronic autoimmune condition; manageable with treatment."),
    Diagnosis("Irritable Bowel Syndrome (IBS)",
              "Abdominal pain/cramping, Bloating, Constipation/Diarrhea.",
              "Symptom evaluation, Stool tests, Colonoscopy (if needed).",
              "IBD (Crohn's/UC), Celiac disease, Lactose intolerance.",
              "Diet modification, Stress management, Antispasmodics.",
              "Chronic but not life-threatening."),
    Diagnosis("Urinary Tract Infection (UTI)",
              "Strong/frequent urge to urinate, Burning sensation while urinating, Strongly scented urine.",
              "Urinalysis, Urine culture.",
              "Vaginitis, Kidney stones, Interstitial cystitis.",
              "Antibiotics, Hydration, Pain relief.",
              "Excellent prognosis with treatment; can worsen if untreated."),
    Diagnosis("Alzheimer's Disease",
              "Memory loss, Difficulty with common tasks/problem solving, Frustration.",
              "Cognitive testing, MRI, PET scan, Blood tests.",
              "Other dementias, Depression, Vitamin deficiencies.",
              "Supportive care, Medications for cognitive symptoms.",
              "Progressive; currently no cure, but symptom management is possible."),
    Diagnosis("Parkinson's Disease",
              "Tremors, Slowness of movement, Stiffness, Balance problems.",
              "Neurological exam, MRI, DaTscan, Response to medication.",
              "Essential tremor, Multiple system atrophy, Drug-induced parkinsonism.",
              "Levodopa, Dopamine agonists, Physical therapy.",
              "Chronic and progressive; symptoms can be managed."),
    Diagnosis("Epilepsy",
              "Sudden episodes of altered behavior, Confusion, Loss of awareness, Uncontrollable jerking/stiffening sensations.",
              "EEG, MRI, Blood tests.",
              "Syncope, Migraine, Psychogenic non-epileptic seizures.",
              "Antiepileptic drugs, Surgery (in some cases), Lifestyle adjustments.",
              "Chronic; seizure control possible in many patients."),
    Diagnosis("Chronic Kidney Disease",
              "Fatigue, Swelling of hands/feet/extremities, Trouble sleeping, Metallic taste in mouth, Altered Urination frequency/appearence.",
              "Blood tests, Urinalysis, Imaging, Kidney biopsy (if needed).",
              "Acute kidney injury, Urinary obstruction, Glomerulonephritis.",
              "Dialysis, Diet modifications, Blood pressure control, Medications.",
              "Progressive; can lead to kidney failure without management."),
    Diagnosis("Heart Failure",
              "Shortness of breath, Fatigue, Swelling, Persistent Cough.",
              "Echocardiogram, ECG, Blood tests, Chest X-ray.",
              "COPD, Kidney disease, Pulmonary embolism.",
              "Diuretics, ACE inhibitors, Beta-blockers, Lifestyle changes.",
              "Chronic; can be managed but requires ongoing care."),
    Diagnosis("Obesity",
              "Fatigue, Shortness of breath, Joint pain, Excessive sweating, Sleep disturbances/apnea.",
              "BMI calculation, Waist circumference, Blood tests.",
              "Hypothyroidism, Cushingâ€™s syndrome, Genetic syndromes.",
              "Lifestyle modification, Medications, Surgery (bariatric).",
              "Increases risk of diabetes, heart disease, stroke, and certain cancers."),
    Diagnosis("Stroke",
              "Balance loss, Vision changes, Face numbness/drooping, Arm weakness/numbness, Speach difficulty.",
              "CT scan, MRI, Physical and neurological exams.",
              "TIA, Migraine with aura, Seizure.",
              "Clot-busting medications, Surgery, Rehabilitation.",
              "Potential permanent neurological damage; time-sensitive treatment.")
  ]
  return diagnoses

def searchBySymptoms(diagnoses):
  try:
    symptSearch = input("Briefly provide some of the major symptoms you are interested in researching (If applicable, seperate by comma. I.e: symptom1, symptom2, etc...): ")
    userSymptoms = [i.strip().lower() for i in symptSearch.split(',')]    
    if not userSymptoms:                                                # create a list of symptoms the user input
      print('No symptoms entered, please try again!') 
      return
    print(f'Analyzing symptoms: {', '.join(userSymptoms)}')
    scoredDiagnoses = []                   #iterate over each diagnosis, and call our matchScore function, 
    for diagnosis in diagnoses:            #comparing users input symptoms to the diagnosis' symptoms.
      score, matchedPairs, matchedDetails = diagnosis.getMatchScore(userSymptoms)
      if score > 0:
        matchedCount = len(matchedPairs)      #score each diagnosis on how similar the symptoms match
        scoredDiagnoses.append({
            'diagnosis':diagnosis,          #store our scored diagnosis with a dictionary, each key has a matching score value
            'score':score,
            'matched count':matchedCount,
            'matched pairs':matchedPairs,
            'match percentage': (matchedCount/len(userSymptoms)) * 100
        })
    scoredDiagnoses.sort(key=lambda x: x['score'],reverse=True)     #sort with highest scoring diagnosis at the bottom of the list
    if not scoredDiagnoses:
      print('\nNo potential diagnoses found! Maybe try changing your description.')
      return
    print(f'\nPotential diangoses located.')
    print('------------------------------')
    topMatches = scoredDiagnoses[:5]
    for i,result in enumerate(topMatches,1):   #print the highest scores with the corresponding diagnosis
      diagnosis = result['diagnosis']
      print(f"{i}) {diagnosis.name} (Match Score: {result['score']:.2f}/1.0)")
      if i == 1:
        print(f"Full symptom list for {diagnosis.name}:")     #for the highest matching diagnosis, print out the symptoms 
        for symptom in diagnosis.symptomsList:               #so user can compare their inputs to the output
          print(f'   -{symptom}')
  except Exception as e:
    print(f'An uncexpected error occured: {e}. Please try again.')

def searchByName(diagnoses):
  nameSearch = input("What diagnosis are you interested in researching? ('^' to see previous prompt): ")
  if nameSearch == '^':
    findResearchMethod()
  else:
    cleanNameSearch = nameSearch.lower().strip()
    for diagnosis in diagnoses:
      if cleanNameSearch in diagnosis.name.lower():
        print(diagnosis)
    return None

def findResearchMethod():
  try: 
    diagnoses = container()
    nameOrSympt = input('Would you like to research by name (n), symptoms (s), or see previous prompt (^)?: ')
    match nameOrSympt.lower():
      case '^':
        prompt1()
      case 'n'|'name'|'names':
        searchByName(diagnoses)
      case 's'|'symptom'|'symptoms':
        searchBySymptoms(diagnoses)
      case _:
        print(f"Invalid choice: {nameOrSympt}. Please enter 'n' for name, 's' for symptoms, or '^' to see previous prompt.")
  except Exception as e:
    print(f'An uncexpected error occured: {e}. Please try again.')

def prompt1():
  try:
    prompt1 = input('Would you like to study (s), research (r), see all (a), or quit (q)?: ')
    match prompt1.lower():
      case 's'|'study':
        study()
      case 'r'|'research':
        findResearchMethod()
      case 'a'|'all' | 'see all' | 'seeall':
        seeAll()
      case 'q'|'quit':
        print('Exiting Program.')
      case _:
        print(f"Invalid choice: {prompt1}. Please enter 's' to study, 'r' to research, 'a' to see all, or 'q' to quit.")
  except Exception as e:
      print(f"An unexpected error occured: {e}. Please try again.")


if __name__ == "__main__":
  prompt1()
